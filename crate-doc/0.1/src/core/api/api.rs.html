<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `core/src/api/api.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>api.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" href="../../../normalize.css"><link rel="stylesheet" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" href="../../../ayu.css" disabled><link rel="stylesheet" href="../../../dark.css" disabled><link rel="stylesheet" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script defer src="../../../source-script.js"></script><script defer src="../../../source-files.js"></script><script defer src="../../../main.js"></script><noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../core/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a><h2 class="location"></h2></nav><nav class="sidebar"><a class="sidebar-logo" href="../../../core/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div></a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../core/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><button type="button">?</button></div><div id="settings-menu" tabindex="-1"><a href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
<span id="160">160</span>
<span id="161">161</span>
<span id="162">162</span>
<span id="163">163</span>
<span id="164">164</span>
<span id="165">165</span>
<span id="166">166</span>
<span id="167">167</span>
<span id="168">168</span>
<span id="169">169</span>
<span id="170">170</span>
<span id="171">171</span>
<span id="172">172</span>
<span id="173">173</span>
<span id="174">174</span>
<span id="175">175</span>
<span id="176">176</span>
<span id="177">177</span>
<span id="178">178</span>
<span id="179">179</span>
<span id="180">180</span>
<span id="181">181</span>
<span id="182">182</span>
<span id="183">183</span>
<span id="184">184</span>
<span id="185">185</span>
<span id="186">186</span>
<span id="187">187</span>
<span id="188">188</span>
<span id="189">189</span>
<span id="190">190</span>
<span id="191">191</span>
<span id="192">192</span>
<span id="193">193</span>
<span id="194">194</span>
<span id="195">195</span>
<span id="196">196</span>
<span id="197">197</span>
<span id="198">198</span>
<span id="199">199</span>
<span id="200">200</span>
<span id="201">201</span>
<span id="202">202</span>
<span id="203">203</span>
<span id="204">204</span>
<span id="205">205</span>
<span id="206">206</span>
<span id="207">207</span>
<span id="208">208</span>
<span id="209">209</span>
<span id="210">210</span>
<span id="211">211</span>
<span id="212">212</span>
<span id="213">213</span>
<span id="214">214</span>
<span id="215">215</span>
<span id="216">216</span>
<span id="217">217</span>
<span id="218">218</span>
<span id="219">219</span>
<span id="220">220</span>
<span id="221">221</span>
<span id="222">222</span>
<span id="223">223</span>
<span id="224">224</span>
<span id="225">225</span>
<span id="226">226</span>
<span id="227">227</span>
<span id="228">228</span>
<span id="229">229</span>
<span id="230">230</span>
<span id="231">231</span>
<span id="232">232</span>
<span id="233">233</span>
<span id="234">234</span>
<span id="235">235</span>
<span id="236">236</span>
<span id="237">237</span>
<span id="238">238</span>
<span id="239">239</span>
<span id="240">240</span>
<span id="241">241</span>
<span id="242">242</span>
<span id="243">243</span>
<span id="244">244</span>
<span id="245">245</span>
<span id="246">246</span>
<span id="247">247</span>
<span id="248">248</span>
<span id="249">249</span>
<span id="250">250</span>
<span id="251">251</span>
<span id="252">252</span>
<span id="253">253</span>
<span id="254">254</span>
<span id="255">255</span>
<span id="256">256</span>
<span id="257">257</span>
<span id="258">258</span>
<span id="259">259</span>
<span id="260">260</span>
<span id="261">261</span>
<span id="262">262</span>
<span id="263">263</span>
<span id="264">264</span>
<span id="265">265</span>
<span id="266">266</span>
<span id="267">267</span>
<span id="268">268</span>
<span id="269">269</span>
<span id="270">270</span>
<span id="271">271</span>
<span id="272">272</span>
<span id="273">273</span>
<span id="274">274</span>
<span id="275">275</span>
<span id="276">276</span>
<span id="277">277</span>
<span id="278">278</span>
<span id="279">279</span>
<span id="280">280</span>
<span id="281">281</span>
<span id="282">282</span>
<span id="283">283</span>
<span id="284">284</span>
<span id="285">285</span>
<span id="286">286</span>
<span id="287">287</span>
<span id="288">288</span>
<span id="289">289</span>
<span id="290">290</span>
<span id="291">291</span>
<span id="292">292</span>
<span id="293">293</span>
<span id="294">294</span>
<span id="295">295</span>
<span id="296">296</span>
<span id="297">297</span>
<span id="298">298</span>
<span id="299">299</span>
<span id="300">300</span>
<span id="301">301</span>
<span id="302">302</span>
<span id="303">303</span>
<span id="304">304</span>
<span id="305">305</span>
<span id="306">306</span>
<span id="307">307</span>
<span id="308">308</span>
<span id="309">309</span>
<span id="310">310</span>
<span id="311">311</span>
<span id="312">312</span>
<span id="313">313</span>
<span id="314">314</span>
<span id="315">315</span>
<span id="316">316</span>
<span id="317">317</span>
<span id="318">318</span>
<span id="319">319</span>
<span id="320">320</span>
<span id="321">321</span>
<span id="322">322</span>
<span id="323">323</span>
<span id="324">324</span>
<span id="325">325</span>
<span id="326">326</span>
<span id="327">327</span>
<span id="328">328</span>
<span id="329">329</span>
<span id="330">330</span>
<span id="331">331</span>
<span id="332">332</span>
<span id="333">333</span>
<span id="334">334</span>
<span id="335">335</span>
<span id="336">336</span>
<span id="337">337</span>
<span id="338">338</span>
<span id="339">339</span>
<span id="340">340</span>
<span id="341">341</span>
<span id="342">342</span>
<span id="343">343</span>
<span id="344">344</span>
<span id="345">345</span>
<span id="346">346</span>
<span id="347">347</span>
<span id="348">348</span>
<span id="349">349</span>
<span id="350">350</span>
<span id="351">351</span>
<span id="352">352</span>
<span id="353">353</span>
<span id="354">354</span>
<span id="355">355</span>
<span id="356">356</span>
<span id="357">357</span>
<span id="358">358</span>
<span id="359">359</span>
<span id="360">360</span>
<span id="361">361</span>
<span id="362">362</span>
<span id="363">363</span>
<span id="364">364</span>
<span id="365">365</span>
<span id="366">366</span>
<span id="367">367</span>
<span id="368">368</span>
<span id="369">369</span>
<span id="370">370</span>
<span id="371">371</span>
<span id="372">372</span>
<span id="373">373</span>
<span id="374">374</span>
<span id="375">375</span>
<span id="376">376</span>
<span id="377">377</span>
<span id="378">378</span>
<span id="379">379</span>
<span id="380">380</span>
<span id="381">381</span>
<span id="382">382</span>
<span id="383">383</span>
<span id="384">384</span>
<span id="385">385</span>
<span id="386">386</span>
<span id="387">387</span>
<span id="388">388</span>
<span id="389">389</span>
<span id="390">390</span>
<span id="391">391</span>
<span id="392">392</span>
<span id="393">393</span>
<span id="394">394</span>
<span id="395">395</span>
<span id="396">396</span>
<span id="397">397</span>
<span id="398">398</span>
<span id="399">399</span>
<span id="400">400</span>
<span id="401">401</span>
<span id="402">402</span>
<span id="403">403</span>
<span id="404">404</span>
<span id="405">405</span>
<span id="406">406</span>
<span id="407">407</span>
<span id="408">408</span>
<span id="409">409</span>
<span id="410">410</span>
<span id="411">411</span>
<span id="412">412</span>
<span id="413">413</span>
<span id="414">414</span>
<span id="415">415</span>
<span id="416">416</span>
<span id="417">417</span>
<span id="418">418</span>
<span id="419">419</span>
<span id="420">420</span>
<span id="421">421</span>
<span id="422">422</span>
<span id="423">423</span>
<span id="424">424</span>
<span id="425">425</span>
<span id="426">426</span>
<span id="427">427</span>
<span id="428">428</span>
<span id="429">429</span>
<span id="430">430</span>
<span id="431">431</span>
<span id="432">432</span>
<span id="433">433</span>
<span id="434">434</span>
<span id="435">435</span>
<span id="436">436</span>
<span id="437">437</span>
<span id="438">438</span>
<span id="439">439</span>
<span id="440">440</span>
<span id="441">441</span>
<span id="442">442</span>
<span id="443">443</span>
<span id="444">444</span>
<span id="445">445</span>
<span id="446">446</span>
<span id="447">447</span>
<span id="448">448</span>
<span id="449">449</span>
<span id="450">450</span>
<span id="451">451</span>
<span id="452">452</span>
<span id="453">453</span>
<span id="454">454</span>
<span id="455">455</span>
<span id="456">456</span>
<span id="457">457</span>
<span id="458">458</span>
<span id="459">459</span>
<span id="460">460</span>
<span id="461">461</span>
<span id="462">462</span>
<span id="463">463</span>
<span id="464">464</span>
<span id="465">465</span>
<span id="466">466</span>
<span id="467">467</span>
<span id="468">468</span>
<span id="469">469</span>
<span id="470">470</span>
<span id="471">471</span>
<span id="472">472</span>
<span id="473">473</span>
<span id="474">474</span>
<span id="475">475</span>
<span id="476">476</span>
<span id="477">477</span>
<span id="478">478</span>
<span id="479">479</span>
<span id="480">480</span>
<span id="481">481</span>
<span id="482">482</span>
<span id="483">483</span>
<span id="484">484</span>
<span id="485">485</span>
<span id="486">486</span>
<span id="487">487</span>
<span id="488">488</span>
<span id="489">489</span>
<span id="490">490</span>
<span id="491">491</span>
<span id="492">492</span>
<span id="493">493</span>
<span id="494">494</span>
<span id="495">495</span>
<span id="496">496</span>
<span id="497">497</span>
<span id="498">498</span>
<span id="499">499</span>
<span id="500">500</span>
<span id="501">501</span>
<span id="502">502</span>
<span id="503">503</span>
<span id="504">504</span>
<span id="505">505</span>
<span id="506">506</span>
<span id="507">507</span>
<span id="508">508</span>
<span id="509">509</span>
<span id="510">510</span>
<span id="511">511</span>
<span id="512">512</span>
<span id="513">513</span>
<span id="514">514</span>
<span id="515">515</span>
<span id="516">516</span>
<span id="517">517</span>
<span id="518">518</span>
<span id="519">519</span>
<span id="520">520</span>
<span id="521">521</span>
<span id="522">522</span>
<span id="523">523</span>
<span id="524">524</span>
<span id="525">525</span>
<span id="526">526</span>
<span id="527">527</span>
<span id="528">528</span>
<span id="529">529</span>
<span id="530">530</span>
<span id="531">531</span>
<span id="532">532</span>
<span id="533">533</span>
<span id="534">534</span>
<span id="535">535</span>
<span id="536">536</span>
<span id="537">537</span>
<span id="538">538</span>
<span id="539">539</span>
<span id="540">540</span>
<span id="541">541</span>
<span id="542">542</span>
<span id="543">543</span>
<span id="544">544</span>
<span id="545">545</span>
<span id="546">546</span>
<span id="547">547</span>
<span id="548">548</span>
<span id="549">549</span>
<span id="550">550</span>
<span id="551">551</span>
<span id="552">552</span>
<span id="553">553</span>
<span id="554">554</span>
<span id="555">555</span>
<span id="556">556</span>
<span id="557">557</span>
<span id="558">558</span>
<span id="559">559</span>
<span id="560">560</span>
<span id="561">561</span>
<span id="562">562</span>
<span id="563">563</span>
<span id="564">564</span>
<span id="565">565</span>
<span id="566">566</span>
<span id="567">567</span>
<span id="568">568</span>
<span id="569">569</span>
<span id="570">570</span>
<span id="571">571</span>
<span id="572">572</span>
<span id="573">573</span>
<span id="574">574</span>
<span id="575">575</span>
</pre><pre class="rust"><code><span class="kw">use super</span>::{
    error::{APIInternalError, ApiError},
    inner_api::InnerAPI,
    APICommands, APIResponses,
};
<span class="kw">use super</span>::{CreateRequest, CreateType, ExternalEventRequest, GetEventsOfSubject};
<span class="kw">use </span>async_trait::async_trait;
<span class="kw">use </span>commons::bd::db::DB;
<span class="kw">use </span>commons::models::approval_signature::Acceptance;
<span class="kw">use </span>commons::models::event::Event;
<span class="kw">use </span>commons::models::event_request::{EventRequest, RequestData, RequestPayload};
<span class="kw">use </span>commons::models::signature::Signature;
<span class="kw">use </span>commons::models::state::SubjectData;
<span class="kw">use </span>commons::{
    channel::{ChannelData, MpscChannel, SenderEnd},
    config::TapleSettings,
    crypto::KeyPair,
};
<span class="kw">use </span>protocol::command_head_manager::manager::CommandAPI;
<span class="kw">use </span>protocol::command_head_manager::{CommandManagerResponses, Commands};
<span class="kw">use </span>protocol::request_manager::manager::RequestManagerAPI;
<span class="kw">use </span>protocol::request_manager::{RequestManagerMessage, RequestManagerResponse};
<span class="kw">use </span>tokio::sync::watch::Sender;

<span class="doccomment">/// Trait that allows implementing the interface of a TAPLE node.
/// The only native implementation is [NodeAPI]. Users can use the trait
/// to add specific behaviors to an existing node interface. For example,
/// a [NodeAPI] wrapper could be created that again implements the trait
/// and perform certain intermediate operations, such as incrementing a counter
/// to find out how many API queries have been made.
</span><span class="attribute">#[async_trait]
</span><span class="kw">pub trait </span>ApiModuleInterface {
    <span class="doccomment">/// Allows to generate a voting request in the system.
    /// This request will be sent to the node that will be in charge of handling
    /// the votes of the rest of the nodes belonging to the same governance.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurs during operation execution.&lt;br /&gt;
    /// • [ApiError::InvalidParameters] if the specified request identifier does not match a valid [DigestIdentifier].&lt;br /&gt;
    </span><span class="kw">async fn </span>create_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        request_type: <span class="kw">super</span>::CreateRequest,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt;;
    <span class="doccomment">/// Allows to make a request to the node from an external Invoker
    </span><span class="kw">async fn </span>external_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        event_request: ExternalEventRequest,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt;;
    <span class="doccomment">/// Allows adding a new event to the chain of a subject previously existing
    /// in the node. The event identifier and its [payload](RequestPayload) are required.
    /// This method returns the enumerated [CreateRequestResponse], being the identifier
    /// of a request when the event intends to update a governance, in which case
    /// it will be communicated to the rest of the nodes aware of the governance with
    /// the intention that they vote the change contained in the request. In case the event
    /// is from a conventional subject, the system returns the created event.
    /// # Possible errors
    /// This method will return [ApiError::EventCreationError] if it has not been possible
    /// to create the event, while [ApiError::InternalError] will be obtained if an internal error
    /// has occurred during the management of the operation. If it has not been possible to create
    /// the signature accompanying the creation of the event with the node identity,
    /// then [ApiError::SignError] will be obtained.
    </span><span class="kw">async fn </span>create_event(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt;;
    <span class="doccomment">/// It allows to simulate the creation of an event, obtaining the state that would
    /// result from the subject in case the event is actually created.
    /// # Possible errors
    /// • [ApiError::InvalidParameters] if the specified identifier does not match a valid [DigestIdentifier]. &lt;br /&gt;
    /// • [ApiError::SignError] if it has not been possible to create the signature that accompanies
    /// the creation of the event with the identity of the node. &lt;br /&gt;
    /// • [ApiError::NotFound] if the specified subject is not registered in the node. &lt;br /&gt;
    /// • [ApiError::InternalError] if an error occurred during simulation execution.
    </span><span class="kw">async fn </span>simulate_event(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;SubjectData, ApiError&gt;;
    <span class="doccomment">/// Allows to get all subjects that are known to the current node, regardless of their governance.
    /// Paging can be performed using the optional arguments `from` and `quantity`.
    /// Regarding the first one, note that it admits negative values, in which case the paging is
    /// performed in the opposite direction starting from the end of the collection. Note that this method
    /// also returns the subjects that model governance.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurred during the execution of the operation.
    </span><span class="kw">async fn </span>get_all_subjects(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        namespace: String,
        from: <span class="prelude-ty">Option</span>&lt;usize&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;usize&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;SubjectData&gt;, ApiError&gt;;
    <span class="doccomment">/// It allows to obtain all the subjects that model existing governance in the node.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurred during the execution of the operation.
    </span><span class="kw">async fn </span>get_all_governances(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;SubjectData&gt;, ApiError&gt;;
    <span class="doccomment">/// Allows to obtain events from a specific subject previously existing in the node.
    /// Paging can be performed by means of the optional arguments `from` and `quantity`.
    /// Regarding the former, it should be noted that negative values are allowed, in which case
    /// the paging is performed in the opposite direction starting from the end of the string.
    /// # Possible errors
    /// • [ApiError::InvalidParameters] if the specified subject identifier does not match a valid [DigestIdentifier].
    </span><span class="kw">async fn </span>get_event_of_subject(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        from: <span class="prelude-ty">Option</span>&lt;i64&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;i64&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;Event&gt;, ApiError&gt;;
    <span class="doccomment">/// Allows to create a new subject in the node, being its owner the node in question.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurred during the execution of the operation.&lt;br /&gt;
    /// • [ApiError::SignError] if it has not been possible to create the signature that accompanies
    /// the creation of the event with the identity of the node.&lt;br /&gt;
    /// • [ApiError::EventCreationError] if it has not been possible to create the subject,
    /// for example, because its governance does not exist.&lt;br /&gt;
    /// • [ApiError::InvalidParameters] if the specified governance identifier does not match a valid [DigestIdentifier].
    </span><span class="kw">async fn </span>create_subject(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        governance_id: String,
        schema_id: String,
        namespace: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt;;
    <span class="doccomment">/// Allows to obtain a specified subject by specifying its identifier.
    /// # Possible errors
    /// • [ApiError::InvalidParameters] if the specified identifier does not match a valid [DigestIdentifier].&lt;br /&gt;
    /// • [ApiError::NotFound] if the subject does not exist.
    </span><span class="kw">async fn </span>get_subject(<span class="kw-2">&amp;</span><span class="self">self</span>, subject_id: String) -&gt; <span class="prelude-ty">Result</span>&lt;SubjectData, ApiError&gt;;
    <span class="doccomment">/// Method for creating governance in the system.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurred during the execution of the operation.&lt;br /&gt;
    /// • [ApiError::SignError] if it has not been possible to create the signature that accompanies
    /// the creation of the event with the identity of the node.&lt;br /&gt;
    /// • [ApiError::EventCreationError] if it has not been possible to create the governance.
    </span><span class="kw">async fn </span>create_governance(<span class="kw-2">&amp;</span><span class="self">self</span>, payload: RequestPayload) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt;;
    <span class="doccomment">/// Method to obtain the validation signatures of an event from a specified subject.
    /// Paging can be performed using the optional arguments `from` and `quantity`.
    /// Regarding the first one, it is worth mentioning that it admits negative values, in which case
    /// the pagination is performed in the opposite direction starting from the end of the collection.
    /// # Possible errors
    /// • [ApiError::NotFound] if the specified subject or subject event does not exist.&lt;br /&gt;
    /// • [ApiError::InvalidParameters] if the specified subject identifier does not match a valid [DigestIdentifier].
    </span><span class="kw">async fn </span>get_signatures(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        sn: u64,
        from: <span class="prelude-ty">Option</span>&lt;usize&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;usize&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;Signature&gt;, ApiError&gt;;
    <span class="doccomment">/// Stops the node, consuming the instance on the fly. This implies that any previously created API
    /// or [NotificationHandler] instances will no longer be functional.
    </span><span class="kw">async fn </span>shutdown(<span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;(), ApiError&gt;;
    <span class="doccomment">/// Allows to vote on a voting request that previously exists in the system.
    /// This vote will be sent to the corresponding node in charge of its collection.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurs during operation execution.&lt;br /&gt;
    /// • [ApiError::NotFound] if the request does not exist in the system.&lt;br /&gt;
    /// • [ApiError::InvalidParameters] if the specified request identifier does not match a valid [DigestIdentifier].&lt;br /&gt;
    /// • [ApiError::VoteNotNeeded] if the node&#39;s vote is no longer required. &lt;br /&gt;
    /// This occurs when the acceptance of the changes proposed by the petition has already been resolved by the rest of the nodes in the network or when the node cannot participate in the voting process because it lacks the voting role.
    </span><span class="kw">async fn </span>approval_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        request_id: String,
        acceptance: Acceptance,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), ApiError&gt;;
    <span class="doccomment">/// It allows to obtain all the voting requests pending to be resolved in the node.
    /// These requests are received from other nodes in the network when they try to update
    /// a governance subject. It is necessary to vote their agreement or disagreement with
    /// the proposed changes in order for the events to be implemented.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurs during operation execution.
    </span><span class="kw">async fn </span>get_pending_requests(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;EventRequest&gt;, ApiError&gt;;
    <span class="doccomment">/// It allows to obtain a single voting request pending to be resolved in the node.
    /// This request is received from other nodes in the network when they try to update
    /// a governance subject. It is necessary to vote its agreement or disagreement with
    /// the proposed changes in order for the events to be implemented.
    /// # Possible errors
    /// • [ApiError::InternalError] if an internal error occurs during operation execution.
    /// • [ApiError::NotFound] if the requested request does not exist.
    </span><span class="kw">async fn </span>get_single_request(<span class="self">self</span>, id: String) -&gt; <span class="prelude-ty">Result</span>&lt;EventRequest, ApiError&gt;;
}

<span class="doccomment">/// Object that allows interaction with a TAPLE node.
///
/// It has methods to perform all available read and write operations,
/// as well as an additional action to stop a running node.
/// he interaction is performed thanks to the implementation of a trait
/// known as [ApiModuleInterface]. Consequently, it is necessary to import
/// the trait in order to properly use the object.
</span><span class="attribute">#[derive(Clone, Debug)]
</span><span class="kw">pub struct </span>NodeAPI {
    <span class="kw">pub</span>(<span class="kw">crate</span>) sender: SenderEnd&lt;APICommands, APIResponses&gt;,
}

<span class="doccomment">/// Feature that allows implementing the API Rest of an Taple node.
</span><span class="attribute">#[async_trait]
</span><span class="kw">impl </span>ApiModuleInterface <span class="kw">for </span>NodeAPI {
    <span class="kw">async fn </span>create_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        request_type: <span class="kw">super</span>::CreateRequest,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::CreateRequest(request_type))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::CreateRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>external_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        event_request: ExternalEventRequest,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::ExternalRequest(event_request))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::ExternalRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>get_pending_requests(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;EventRequest&gt;, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetPendingRequests)
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetPendingRequests(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>get_single_request(<span class="self">self</span>, id: String) -&gt; <span class="prelude-ty">Result</span>&lt;EventRequest, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetSingleRequest(id))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetSingleRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>create_event(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt; {
        <span class="kw">let </span>request = CreateRequest::State(<span class="kw">crate</span>::api::StateType {
            subject_id,
            payload,
        });
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::CreateRequest(request))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::CreateRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>simulate_event(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;SubjectData, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::SimulateEvent(<span class="kw">super</span>::CreateEvent {
                subject_id,
                payload,
            }))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::SimulateEvent(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>get_all_subjects(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        namespace: String,
        from: <span class="prelude-ty">Option</span>&lt;usize&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;usize&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;SubjectData&gt;, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetAllSubjects(<span class="kw">super</span>::GetAllSubjects {
                namespace,
                from,
                quantity,
            }))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetAllSubjects(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>get_all_governances(<span class="kw-2">&amp;</span><span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;SubjectData&gt;, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetAllGovernances)
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetAllGovernances(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>get_event_of_subject(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        from: <span class="prelude-ty">Option</span>&lt;i64&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;i64&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;Event&gt;, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetEventsOfSubject(GetEventsOfSubject {
                subject_id,
                from,
                quantity,
            }))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetEventsOfSubject(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>create_subject(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        governance_id: String,
        schema_id: String,
        namespace: String,
        payload: RequestPayload,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt; {
        <span class="kw">let </span>request = CreateRequest::Create(CreateType {
            governance_id,
            schema_id,
            namespace,
            payload,
        });
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::CreateRequest(request))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::CreateRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>get_subject(<span class="kw-2">&amp;</span><span class="self">self</span>, subject_id: String) -&gt; <span class="prelude-ty">Result</span>&lt;SubjectData, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetSingleSubject(<span class="kw">super</span>::GetSingleSubject {
                subject_id,
            }))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetSingleSubject(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>create_governance(<span class="kw-2">&amp;</span><span class="self">self</span>, payload: RequestPayload) -&gt; <span class="prelude-ty">Result</span>&lt;RequestData, ApiError&gt; {
        <span class="kw">let </span>request = CreateRequest::Create(CreateType {
            governance_id: <span class="string">&quot;&quot;</span>.into(),
            schema_id: <span class="string">&quot;governance&quot;</span>.into(),
            namespace: <span class="string">&quot;&quot;</span>.into(),
            payload,
        });
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::CreateRequest(request))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::CreateRequest(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
    <span class="kw">async fn </span>get_signatures(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        subject_id: String,
        sn: u64,
        from: <span class="prelude-ty">Option</span>&lt;usize&gt;,
        quantity: <span class="prelude-ty">Option</span>&lt;usize&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;Vec&lt;Signature&gt;, ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::GetSignatures(<span class="kw">super</span>::GetSignatures {
                subject_id,
                sn,
                from,
                quantity,
            }))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::GetSignatures(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>approval_request(
        <span class="kw-2">&amp;</span><span class="self">self</span>,
        request_id: String,
        acceptance: Acceptance,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;(), ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self
            </span>.sender
            .ask(APICommands::VoteResolve(acceptance, request_id))
            .<span class="kw">await
            </span>.unwrap();
        <span class="kw">if let </span>APIResponses::VoteResolve(data) = response {
            data
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }

    <span class="kw">async fn </span>shutdown(<span class="self">self</span>) -&gt; <span class="prelude-ty">Result</span>&lt;(), ApiError&gt; {
        <span class="kw">let </span>response = <span class="self">self</span>.sender.ask(APICommands::Shutdown).<span class="kw">await</span>.unwrap();
        <span class="kw">if let </span>APIResponses::ShutdownCompleted = response {
            <span class="prelude-val">Ok</span>(())
        } <span class="kw">else </span>{
            <span class="macro">unreachable!</span>()
        }
    }
}

<span class="kw">pub struct </span>API {
    input: MpscChannel&lt;APICommands, APIResponses&gt;,
    _settings_sender: Sender&lt;TapleSettings&gt;,
    inner_api: InnerAPI,
    shutdown_sender: <span class="prelude-ty">Option</span>&lt;tokio::sync::broadcast::Sender&lt;()&gt;&gt;,
    shutdown_receiver: tokio::sync::broadcast::Receiver&lt;()&gt;,
}

<span class="kw">impl </span>API {
    <span class="kw">pub fn </span>new(
        input: MpscChannel&lt;APICommands, APIResponses&gt;,
        command_output: SenderEnd&lt;Commands, CommandManagerResponses&gt;,
        request_output: SenderEnd&lt;RequestManagerMessage, RequestManagerResponse&gt;,
        settings_sender: Sender&lt;TapleSettings&gt;,
        initial_settings: TapleSettings,
        keys: KeyPair,
        shutdown_sender: tokio::sync::broadcast::Sender&lt;()&gt;,
        shutdown_receiver: tokio::sync::broadcast::Receiver&lt;()&gt;,
        db: DB,
    ) -&gt; <span class="self">Self </span>{
        <span class="self">Self </span>{
            input,
            _settings_sender: settings_sender,
            inner_api: InnerAPI::new(
                keys,
                <span class="kw-2">&amp;</span>initial_settings,
                CommandAPI::new(command_output),
                db,
                RequestManagerAPI::new(request_output),
            ),
            shutdown_sender: <span class="prelude-val">Some</span>(shutdown_sender),
            shutdown_receiver: shutdown_receiver,
        }
    }

    <span class="kw">pub async fn </span>start(<span class="kw-2">mut </span><span class="self">self</span>) {
        <span class="kw">let </span><span class="kw-2">mut </span>response_channel = <span class="prelude-val">None</span>;
        <span class="kw">loop </span>{
            <span class="macro">tokio::select! </span>{
                msg = <span class="self">self</span>.input.receive() =&gt; {
                    <span class="kw">let </span>must_shutdown = <span class="kw">if </span>msg.is_none() {
                        <span class="comment">// Channel closed
                        </span><span class="bool-val">true
                    </span>} <span class="kw">else </span>{
                        <span class="kw">let </span>result = <span class="self">self</span>.process_input(msg.unwrap()).<span class="kw">await</span>;
                        <span class="kw">if </span>result.is_err() {
                            <span class="bool-val">true
                        </span>} <span class="kw">else </span>{
                            <span class="kw">let </span>response = result.unwrap();
                            <span class="kw">if </span>response.is_some() {
                                response_channel = response;
                                <span class="bool-val">true
                            </span>} <span class="kw">else </span>{
                                <span class="bool-val">false
                            </span>}
                        }
                    };
                    <span class="kw">if </span>must_shutdown {
                        <span class="kw">let </span>sender = <span class="self">self</span>.shutdown_sender.take().unwrap();
                        sender.send(()).expect(<span class="string">&quot;Shutdown Channel Closed&quot;</span>);
                        drop(sender);
                        <span class="kw">_ </span>= <span class="self">self</span>.shutdown_receiver.recv().<span class="kw">await</span>;
                        <span class="kw">if </span>response_channel.is_some() {
                            <span class="kw">let </span>response_channel = response_channel.unwrap();
                            <span class="kw">let _ </span>= response_channel.send(APIResponses::ShutdownCompleted);
                        }
                        <span class="kw">break</span>;
                    }
                },
                <span class="kw">_ </span>= <span class="self">self</span>.shutdown_receiver.recv() =&gt; {
                    <span class="kw">break</span>;
                }
            }
        }
    }

    <span class="kw">async fn </span>process_input(
        <span class="kw-2">&amp;mut </span><span class="self">self</span>,
        input: ChannelData&lt;APICommands, APIResponses&gt;,
    ) -&gt; <span class="prelude-ty">Result</span>&lt;<span class="prelude-ty">Option</span>&lt;tokio::sync::oneshot::Sender&lt;APIResponses&gt;&gt;, APIInternalError&gt; {
        <span class="comment">// TODO: API commands to change the configuration are missing
        </span><span class="kw">match </span>input {
            ChannelData::AskData(data) =&gt; {
                <span class="kw">let </span>(sx, command) = data.get();
                <span class="kw">let </span>response = <span class="kw">match </span>command {
                    APICommands::Shutdown =&gt; {
                        <span class="kw">return </span><span class="prelude-val">Ok</span>(<span class="prelude-val">Some</span>(sx));
                    }
                    APICommands::GetAllSubjects(data) =&gt; <span class="self">self</span>.inner_api.get_all_subjects(data),
                    APICommands::GetAllGovernances =&gt; <span class="self">self</span>.inner_api.get_all_governances().<span class="kw">await</span>,
                    APICommands::GetEventsOfSubject(data) =&gt; {
                        <span class="self">self</span>.inner_api.get_events_of_subject(data).<span class="kw">await
                    </span>}
                    APICommands::GetSignatures(data) =&gt; <span class="self">self</span>.inner_api.get_signatures(data).<span class="kw">await</span>,
                    APICommands::GetSingleSubject(data) =&gt; {
                        <span class="self">self</span>.inner_api.get_single_subject(data).<span class="kw">await
                    </span>}
                    APICommands::SimulateEvent(data) =&gt; <span class="self">self</span>.inner_api.simulate_event(data).<span class="kw">await</span>,
                    APICommands::VoteResolve(acceptance, id) =&gt; {
                        <span class="self">self</span>.inner_api.approval_acceptance(acceptance, id).<span class="kw">await
                    </span>}
                    APICommands::GetPendingRequests =&gt; <span class="self">self</span>.inner_api.get_pending_request().<span class="kw">await</span>,
                    APICommands::GetSingleRequest(data) =&gt; {
                        <span class="self">self</span>.inner_api.get_single_request(data).<span class="kw">await
                    </span>}
                    APICommands::CreateRequest(data) =&gt; <span class="self">self</span>.inner_api.create_request(data).<span class="kw">await</span>,
                    APICommands::ExternalRequest(event_request) =&gt; {
                        <span class="kw">let </span>response = <span class="self">self</span>.inner_api.external_request(event_request).<span class="kw">await</span>;
                        response
                    }
                };
                sx.send(response)
                    .map_err(|<span class="kw">_</span>| APIInternalError::OneshotUnavailable)<span class="question-mark">?</span>;
            }
            ChannelData::TellData(_data) =&gt; {
                <span class="macro">panic!</span>(<span class="string">&quot;Tell in API&quot;</span>)
            }
        }
        <span class="prelude-val">Ok</span>(<span class="prelude-val">None</span>)
    }
}
</code></pre></div>
</section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="core" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.65.0 (897e37553 2022-11-02)" ></div></body></html>